;==============================================================================
;  ISTRUZIONI STRATEGY TESTER - SUGAMARA
;  Versione: 1.0
;  Data: 2026-01-06
;==============================================================================
;
;  Questo documento contiene le istruzioni complete per implementare
;  TesterMode.mqh unificato che ingloba DebugMode.
;
;==============================================================================

;------------------------------------------------------------------------------
; SEZIONE 1: OBIETTIVO
;------------------------------------------------------------------------------

[OBIETTIVO]
; Creare un modulo TesterMode.mqh che:
; 1. Rileva AUTOMATICAMENTE se siamo nel Strategy Tester
; 2. Fa partire la grid AUTOMATICAMENTE al primo tick (nel tester)
; 3. Bypassa i blocchi che impediscono il backtest (Session, Recovery, ecc.)
; 4. Ingloba le funzionalita di DebugMode (auto-start manuale per Demo/Real)
; 5. Ha un kill switch per disattivare tutto manualmente
;
; RISULTATO ATTESO:
; - Strategy Tester: tutti i 28 ordini si aprono, zero configurazione
; - Demo/Real: comportamento IDENTICO a prima

;------------------------------------------------------------------------------
; SEZIONE 2: FILE DA CREARE
;------------------------------------------------------------------------------

[FILE_NUOVO]
Path=Core/TesterMode.mqh
Descrizione=Modulo unificato TesterMode + DebugMode

;------------------------------------------------------------------------------
; SEZIONE 3: FILE DA ELIMINARE
;------------------------------------------------------------------------------

[FILE_DA_ELIMINARE]
File1=Core/DebugMode.mqh
File2=Test Mode/TesterMode.mqh
File3=Test Mode/SOLUZIONI_STRATEGY_TESTER.md
Nota=Le funzionalita vengono assorbite nel nuovo TesterMode.mqh

;------------------------------------------------------------------------------
; SEZIONE 4: PARAMETRI INPUT (in InputParameters.mqh)
;------------------------------------------------------------------------------

[PARAMETRI_INPUT]
; Sostituire la sezione "DEBUG MODE" (linee 28-41) con:

Sezione_Nuova=
; input group "                                                           "
; input group "========================================================="
; input group "  TESTER MODE - AUTO START SETTINGS                       "
; input group "========================================================="
;
; input group "    STRATEGY TESTER"
; input bool      EnableTesterMode = true;          // Abilita Tester Mode (auto-detect)
; // Quando TRUE: nel Strategy Tester il sistema parte automaticamente
; // Quando FALSE: disabilita completamente TesterMode (anche nel tester)
;
; input group "    AUTO-START MANUALE (Real/Demo)"
; input bool      EnableAutoStart = false;          // Auto-start in Demo/Real
; input bool      AutoStart_Immediate = true;       // Entry immediato al primo tick
; input string    AutoStart_Time = "09:30";         // Entry schedulato (HH:MM)
; input string    AutoClose_Time = "";              // Close schedulato (vuoto = no close)

;------------------------------------------------------------------------------
; SEZIONE 5: STRUTTURA TesterMode.mqh
;------------------------------------------------------------------------------

[TESTERMODE_STRUTTURA]

; === VARIABILI GLOBALI ===
Variabile1=bool g_isTester = false
Variabile2=bool g_isOptimization = false
Variabile3=bool g_autoStartTriggered = false
Variabile4=bool g_testerInitComplete = false

; === FUNZIONI PRINCIPALI ===
Funzione1=InitializeTesterMode()       ; Chiamata in OnInit()
Funzione2=IsTesterMode()               ; Ritorna true se nel tester
Funzione3=IsOptimizationMode()         ; Ritorna true se in optimization
Funzione4=CheckAutoStart()             ; Chiamata in OnTick() - gestisce auto-start
Funzione5=CheckScheduledClose()        ; Chiamata in OnTick() - gestisce close schedulato

; === FUNZIONI SKIP (bypass blocchi) ===
Skip1=ShouldSkipUI()                   ; Skip Dashboard nel tester
Skip2=ShouldSkipRecovery()             ; Skip Recovery nel tester
Skip3=ShouldSkipSessionCheck()         ; Skip Session Manager nel tester
Skip4=ShouldSkipVolatilityCheck()      ; Skip volatility check nel tester
Skip5=ShouldSkipAlerts()               ; Skip Alert() nel tester
Skip6=ShouldRelaxPriceValidation()     ; Relaxed price validation nel tester

;------------------------------------------------------------------------------
; SEZIONE 6: CODICE TesterMode.mqh
;------------------------------------------------------------------------------

[TESTERMODE_CODICE]
; Codice completo da inserire in Core/TesterMode.mqh:

Codice=
; //+------------------------------------------------------------------+
; //|                                              TesterMode.mqh      |
; //|                   Sugamara - Tester Mode Manager                 |
; //|                                                                  |
; //|  Gestisce:                                                       |
; //|  - Strategy Tester: auto-start, bypass blocchi                   |
; //|  - Debug Mode: auto-start manuale per Demo/Real                  |
; //+------------------------------------------------------------------+
; #property copyright "Sugamara (C) 2025"
; #property link      "https://sugamara.com"
;
; //+------------------------------------------------------------------+
; //| VARIABILI GLOBALI TESTER MODE                                    |
; //+------------------------------------------------------------------+
; bool g_isTester = false;              // TRUE se Strategy Tester attivo
; bool g_isOptimization = false;        // TRUE se Optimization attiva
; bool g_autoStartTriggered = false;    // Flag: auto-start gia eseguito
; bool g_testerInitComplete = false;    // Flag: init tester completato
; datetime g_autoStartTime = 0;         // Timestamp auto-start
;
; //+------------------------------------------------------------------+
; //| INIZIALIZZAZIONE (chiamare in OnInit)                            |
; //+------------------------------------------------------------------+
; void InitializeTesterMode() {
;     // Kill switch: se EnableTesterMode=false, disabilita tutto
;     if(!EnableTesterMode) {
;         g_isTester = false;
;         g_isOptimization = false;
;         g_testerInitComplete = true;
;         Print("TesterMode: DISABILITATO (EnableTesterMode=false)");
;         return;
;     }
;
;     // Rilevamento automatico ambiente
;     g_isTester = (bool)MQLInfoInteger(MQL_TESTER);
;     g_isOptimization = (bool)MQLInfoInteger(MQL_OPTIMIZATION);
;     g_autoStartTriggered = false;
;     g_testerInitComplete = true;
;
;     // Log stato
;     if(g_isTester) {
;         Print("=====================================================");
;         Print("  TESTER MODE ATTIVO");
;         Print("=====================================================");
;         Print("  Optimization: ", g_isOptimization ? "SI" : "NO");
;         Print("  Auto-Start: ABILITATO");
;         Print("  Session Manager: BYPASS");
;         Print("  Recovery: BYPASS");
;         Print("  Dashboard: ", g_isOptimization ? "SKIP" : "ATTIVO");
;         Print("=====================================================");
;     } else {
;         Print("TesterMode: OFF (ambiente Real/Demo rilevato)");
;         if(EnableAutoStart) {
;             Print("  AutoStart manuale: ABILITATO");
;             if(AutoStart_Immediate) {
;                 Print("  Modalita: IMMEDIATA");
;             } else {
;                 Print("  Modalita: SCHEDULATA alle ", AutoStart_Time);
;             }
;         }
;     }
; }
;
; //+------------------------------------------------------------------+
; //| FUNZIONI DI RILEVAMENTO                                          |
; //+------------------------------------------------------------------+
; bool IsTesterMode() {
;     return g_isTester;
; }
;
; bool IsOptimizationMode() {
;     return g_isOptimization;
; }
;
; //+------------------------------------------------------------------+
; //| FUNZIONI SKIP (bypass blocchi nel tester)                        |
; //+------------------------------------------------------------------+
; bool ShouldSkipUI() {
;     // Nel tester optimization, skip UI per performance
;     // Nel tester visual, mantieni UI
;     return g_isOptimization;
; }
;
; bool ShouldSkipRecovery() {
;     // Nel tester, GlobalVariables sono isolate - skip recovery
;     return g_isTester;
; }
;
; bool ShouldSkipSessionCheck() {
;     // Nel tester, ignora orari sessione
;     return g_isTester;
; }
;
; bool ShouldSkipVolatilityCheck() {
;     // Nel tester, ignora check volatilita
;     return g_isTester;
; }
;
; bool ShouldSkipAlerts() {
;     // Nel tester, skip Alert() per performance
;     return g_isTester;
; }
;
; bool ShouldRelaxPriceValidation() {
;     // Nel tester, essere piu permissivi sulla validazione prezzi
;     return g_isTester;
; }
;
; //+------------------------------------------------------------------+
; //| AUTO-START (chiamare in OnTick)                                  |
; //+------------------------------------------------------------------+
; void CheckAutoStart() {
;     // Se gia triggered, esci
;     if(g_autoStartTriggered) return;
;
;     // Se sistema non e in IDLE, esci
;     if(systemState != STATE_IDLE) return;
;
;     // CASO 1: Strategy Tester - sempre auto-start
;     if(g_isTester) {
;         ExecuteAutoStart("TESTER MODE");
;         return;
;     }
;
;     // CASO 2: Real/Demo con EnableAutoStart=true
;     if(EnableAutoStart) {
;         if(AutoStart_Immediate) {
;             // Entry immediato al primo tick
;             ExecuteAutoStart("AUTO-START IMMEDIATO");
;         }
;         else if(IsScheduledStartTime()) {
;             // Entry all'ora programmata
;             ExecuteAutoStart("AUTO-START SCHEDULATO " + AutoStart_Time);
;         }
;     }
; }
;
; //+------------------------------------------------------------------+
; //| ESECUZIONE AUTO-START                                            |
; //+------------------------------------------------------------------+
; void ExecuteAutoStart(string source) {
;     Print("");
;     Print("=====================================================");
;     Print("  AUTO-START ATTIVATO");
;     Print("=====================================================");
;     Print("  Fonte: ", source);
;     Print("  Tempo: ", TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS));
;     Print("=====================================================");
;     Print("");
;
;     // Avvia il sistema grid
;     StartGridSystem();
;
;     // Marca come triggered
;     g_autoStartTriggered = true;
;     g_autoStartTime = TimeCurrent();
; }
;
; //+------------------------------------------------------------------+
; //| CHECK ORARIO START SCHEDULATO                                    |
; //+------------------------------------------------------------------+
; bool IsScheduledStartTime() {
;     if(StringLen(AutoStart_Time) < 4) return false;
;
;     // Parse orario (formato HH:MM)
;     int colonPos = StringFind(AutoStart_Time, ":");
;     if(colonPos < 0) return false;
;
;     int targetHour = (int)StringToInteger(StringSubstr(AutoStart_Time, 0, colonPos));
;     int targetMin = (int)StringToInteger(StringSubstr(AutoStart_Time, colonPos + 1));
;
;     // Ora corrente
;     MqlDateTime dt;
;     TimeToStruct(TimeCurrent(), dt);
;
;     // Confronto
;     int currentMinutes = dt.hour * 60 + dt.min;
;     int targetMinutes = targetHour * 60 + targetMin;
;
;     return (currentMinutes >= targetMinutes);
; }
;
; //+------------------------------------------------------------------+
; //| CHECK CLOSE SCHEDULATO (chiamare in OnTick)                      |
; //+------------------------------------------------------------------+
; void CheckScheduledClose() {
;     // Nel tester non serve close schedulato
;     if(g_isTester) return;
;
;     // Se AutoClose non configurato, esci
;     if(!EnableAutoStart) return;
;     if(StringLen(AutoClose_Time) == 0) return;
;
;     // Se sistema non attivo, esci
;     if(systemState != STATE_ACTIVE) return;
;
;     // Check se e ora di chiudere
;     if(IsScheduledCloseTime()) {
;         Print("");
;         Print("=====================================================");
;         Print("  CLOSE SCHEDULATO ATTIVATO");
;         Print("=====================================================");
;         Print("  Orario: ", AutoClose_Time);
;         Print("=====================================================");
;
;         // Chiudi tutto
;         CloseAllSugamaraOrders();
;         systemState = STATE_IDLE;
;     }
; }
;
; //+------------------------------------------------------------------+
; //| CHECK ORARIO CLOSE SCHEDULATO                                    |
; //+------------------------------------------------------------------+
; bool IsScheduledCloseTime() {
;     if(StringLen(AutoClose_Time) < 4) return false;
;
;     // Parse orario
;     int colonPos = StringFind(AutoClose_Time, ":");
;     if(colonPos < 0) return false;
;
;     int targetHour = (int)StringToInteger(StringSubstr(AutoClose_Time, 0, colonPos));
;     int targetMin = (int)StringToInteger(StringSubstr(AutoClose_Time, colonPos + 1));
;
;     // Ora corrente
;     MqlDateTime dt;
;     TimeToStruct(TimeCurrent(), dt);
;
;     // Confronto (trigger esatto al minuto)
;     return (dt.hour == targetHour && dt.min == targetMin);
; }
;
; //+------------------------------------------------------------------+
; //| LOG STATISTICHE FINALI (chiamare in OnDeinit)                    |
; //+------------------------------------------------------------------+
; void LogTesterStatistics() {
;     if(!g_isTester) return;
;
;     Print("");
;     Print("=====================================================");
;     Print("  TESTER MODE - STATISTICHE FINALI");
;     Print("=====================================================");
;     Print("  Auto-Start eseguito: ", g_autoStartTriggered ? "SI" : "NO");
;     if(g_autoStartTriggered) {
;         Print("  Timestamp: ", TimeToString(g_autoStartTime, TIME_DATE|TIME_SECONDS));
;     }
;     Print("=====================================================");
; }

;------------------------------------------------------------------------------
; SEZIONE 7: MODIFICHE A Sugamara.mq5
;------------------------------------------------------------------------------

[MODIFICHE_SUGAMARA]

; 1. Aggiungere include (dopo linea 95)
Modifica1_Dove=Dopo #include "Core/DebugMode.mqh"
Modifica1_Rimuovi=#include "Core/DebugMode.mqh"
Modifica1_Aggiungi=#include "Core/TesterMode.mqh"

; 2. OnInit - Inizializzazione (dopo linea 103)
Modifica2_Dove=Inizio OnInit, dopo validazioni iniziali
Modifica2_Aggiungi=InitializeTesterMode();

; 3. OnInit - Recovery check (linea ~137)
Modifica3_Dove=if(HasExistingOrders())
Modifica3_Prima=if(HasExistingOrders()) {
Modifica3_Dopo=if(!ShouldSkipRecovery() && HasExistingOrders()) {

; 4. OnTick - Auto-start (linea ~498)
Modifica4_Dove=Prima di CheckDebugModeEntry()
Modifica4_Rimuovi=CheckDebugModeEntry();
Modifica4_Aggiungi=CheckAutoStart();

; 5. OnTick - Close schedulato (linea ~499)
Modifica5_Dove=Dopo CheckAutoStart()
Modifica5_Rimuovi=CheckDebugModeClose();
Modifica5_Aggiungi=CheckScheduledClose();

; 6. OnTick - Session check (linea ~507)
Modifica6_Dove=if(!IsWithinTradingSession())
Modifica6_Prima=if(!IsWithinTradingSession()) {
Modifica6_Dopo=if(!ShouldSkipSessionCheck() && !IsWithinTradingSession()) {

; 7. OnTick - Dashboard update (linea ~602)
Modifica7_Dove=UpdateDashboard()
Modifica7_Prima=UpdateDashboard();
Modifica7_Dopo=if(!ShouldSkipUI()) { UpdateDashboard(); }

; 8. OnDeinit - Statistiche finali
Modifica8_Dove=Fine OnDeinit
Modifica8_Aggiungi=LogTesterStatistics();

;------------------------------------------------------------------------------
; SEZIONE 8: MODIFICHE A BrokerValidation.mqh
;------------------------------------------------------------------------------

[MODIFICHE_BROKERVALIDATION]

; Modificare IsValidPendingPrice() (linea 316)
Modifica_Dove=Inizio funzione IsValidPendingPrice
Modifica_Aggiungi=
; // Nel tester, essere piu permissivi
; if(ShouldRelaxPriceValidation()) {
;     return (price > 0);
; }

;------------------------------------------------------------------------------
; SEZIONE 9: MODIFICHE A InputParameters.mqh
;------------------------------------------------------------------------------

[MODIFICHE_INPUTPARAMETERS]

; Sostituire sezione DEBUG MODE (linee 28-41)
Rimuovi_Da_Linea=28
Rimuovi_A_Linea=41

Nuova_Sezione=
; input group "                                                           "
; input group "========================================================="
; input group "  TESTER MODE - AUTO START SETTINGS                       "
; input group "========================================================="
;
; input group "    STRATEGY TESTER"
; input bool      EnableTesterMode = true;          // Abilita Tester Mode (auto-detect)
;
; input group "    AUTO-START MANUALE (Real/Demo)"
; input bool      EnableAutoStart = false;          // Auto-start in Demo/Real
; input bool      AutoStart_Immediate = true;       // Entry immediato al primo tick
; input string    AutoStart_Time = "09:30";         // Entry schedulato (HH:MM)
; input string    AutoClose_Time = "";              // Close schedulato (HH:MM)

;------------------------------------------------------------------------------
; SEZIONE 10: CHECKLIST IMPLEMENTAZIONE
;------------------------------------------------------------------------------

[CHECKLIST]

Step01=[ ] Creare Core/TesterMode.mqh con codice completo
Step02=[ ] Modificare Config/InputParameters.mqh (nuovi parametri)
Step03=[ ] Modificare Sugamara.mq5 (include + chiamate funzioni)
Step04=[ ] Modificare Core/BrokerValidation.mqh (relax validation)
Step05=[ ] Eliminare Core/DebugMode.mqh
Step06=[ ] Eliminare Test Mode/TesterMode.mqh
Step07=[ ] Eliminare Test Mode/SOLUZIONI_STRATEGY_TESTER.md
Step08=[ ] Compilare e verificare zero errori
Step09=[ ] Test Strategy Tester: verificare 28 ordini aperti
Step10=[ ] Test Visual Mode: verificare ordini visibili
Step11=[ ] Test Demo: verificare comportamento normale (click START)
Step12=[ ] Test Demo con EnableAutoStart=true: verificare auto-start

;------------------------------------------------------------------------------
; SEZIONE 11: COMPORTAMENTO ATTESO
;------------------------------------------------------------------------------

[COMPORTAMENTO]

; STRATEGY TESTER (EnableTesterMode=true, default)
Tester_AutoStart=SI, automatico al primo tick
Tester_Ordini=Tutti i 28 ordini si aprono
Tester_Session=Bypassato
Tester_Recovery=Bypassato
Tester_Dashboard=Attivo in Visual, Skip in Optimization
Tester_Configurazione=NESSUNA, tutto automatico

; DEMO/REAL (EnableTesterMode non rilevante)
Real_AutoStart=Solo se EnableAutoStart=true
Real_Ordini=Normali, come sempre
Real_Session=ATTIVO
Real_Recovery=ATTIVO
Real_Dashboard=ATTIVO
Real_Configurazione=Click START oppure EnableAutoStart

; KILL SWITCH (EnableTesterMode=false)
KillSwitch_Effetto=TesterMode completamente disabilitato
KillSwitch_Tester=Comporta come Real (no bypass)
KillSwitch_Uso=Debug o paranoia di sicurezza

;------------------------------------------------------------------------------
; SEZIONE 12: NOTE FINALI
;------------------------------------------------------------------------------

[NOTE]

Nota1=Il rilevamento Strategy Tester e AUTOMATICO tramite MQL_TESTER
Nota2=Non serve cambiare parametri per passare da Tester a Real
Nota3=EnableTesterMode e un kill switch, default TRUE
Nota4=EnableAutoStart e per Demo/Real, default FALSE
Nota5=La logica di trading (OrderManager, Grid, ecc.) NON viene modificata
Nota6=Solo i "blocchi" vengono bypassati nel tester

;==============================================================================
; FINE ISTRUZIONI
;==============================================================================
