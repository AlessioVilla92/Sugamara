; ============================================================================
; RISOLUZIONE BUG ORDINI DUPLICATI - SUGAMARA v9.23
; ============================================================================
; Data: 15 Gennaio 2026
; Bug Report Originale: Sug_15/BUG_ORDINI_DUPLICATI_20260115.md
; ============================================================================

[PROBLEMA_ORIGINALE]
; L'EA apriva ordini duplicati sullo stesso livello della griglia quando un
; ordine pending veniva eseguito (filled). Nel log del 14/01/2026 sono stati
; trovati 5+ ordini SELL duplicati per Grid B-Upper-L1.

Sintomo = Ordini duplicati allo stesso livello della griglia
Simboli_Interessati = EURUSD, GBPUSD (e potenzialmente tutti)
Gravita = CRITICO
Impatto = Esposizione raddoppiata, perdite amplificate, hedging sbilanciato

; ============================================================================
[ANALISI_CRITICA_FILE_BUG]
; ============================================================================
; Il file BUG_ORDINI_DUPLICATI_20260115.md conteneva una diagnosi PARZIALMENTE
; ERRATA della causa del problema.

Diagnosi_File_BUG = Il position ticket e diverso dall order ticket
Verdetto = ERRATO per hedging mode

; In MT5 HEDGING MODE (che e quello usato da Sugamara, confermato dai log),
; il position ticket E UGUALE all order ticket nella maggior parte dei casi.

Prova_Hedging = Journal log 20260114-J.log riga 755
Prova_Testo = 10:01:45.610 Network trading has been enabled - hedging mode

; ============================================================================
[VERA_CAUSA_DEL_BUG]
; ============================================================================
; La vera causa e una RACE CONDITION combinata con un handler incompleto.

Causa_Principale = RACE CONDITION + HANDLER INCOMPLETO
Handler_Problema = ProcessDealEvent() ignorava DEAL_ENTRY_IN

; PROVA EMPIRICA:
; Stesso timestamp al MILLISECONDO tra deal e Order cancelled
; Journal:  13:56:08.667 -> deal #32133306 sell done (order #35054485)
; EA Log:   13:56:08.667 -> Order cancelled per Grid B Upper L1

; FLUSSO DEL BUG:
; 1. Ordine pending piazzato (status = ORDER_PENDING)
; 2. MT5 esegue ordine -> genera TRADE_TRANSACTION_DEAL_ADD con DEAL_ENTRY_IN
; 3. OnTradeTransaction riceve evento
; 4. ProcessDealEvent() controlla entry type -> DEAL_ENTRY_IN -> IGNORA!
; 5. Status rimane ORDER_PENDING
; 6. OnTick esegue (stesso millisecondo!)
; 7. UpdateGridBUpperStatus():
;    - OrderSelect(ticket) -> FALSE (ordine non piu pending)
;    - PositionSelectByTicket(ticket) -> FALSE (race condition!)
; 8. Status = ORDER_CANCELLED <- ERRORE!
; 9. ShouldReopenGridBUpper() -> TRUE (perche CANCELLED)
; 10. Cyclic Reopen piazza DUPLICATO!

; ============================================================================
[SOLUZIONE_IMPLEMENTATA]
; ============================================================================

; STEP 1: Modificato ProcessDealEvent() in PositionMonitor.mqh (riga 529-535)
; Aggiunto handling per DEAL_ENTRY_IN prima del check per exit deals

File_Modificato_1 = Trading/PositionMonitor.mqh
Riga_Modifica_1 = 529-535
Codice_Aggiunto_1 = if(entry == DEAL_ENTRY_IN) { ProcessOrderFilled(dealTicket); return; }

; STEP 2: Aggiunta funzione ProcessOrderFilled() in PositionMonitor.mqh (riga 577-617)
; Questa funzione cerca il ticket negli array delle grid e aggiorna lo status
; a ORDER_FILLED PRIMA che OnTick possa eseguire il polling

File_Modificato_2 = Trading/PositionMonitor.mqh
Riga_Modifica_2 = 572-618
Funzione_Aggiunta = ProcessOrderFilled(ulong dealTicket)

; STEP 3: Aggiunta funzione FindPositionAtPrice() in Utils/Helpers.mqh (riga 798-819)
; Safety net che cerca posizioni per prezzo come fallback

File_Modificato_3 = Utils/Helpers.mqh
Riga_Modifica_3 = 798-819
Funzione_Aggiunta = FindPositionAtPrice(double price, ENUM_POSITION_TYPE posType, long targetMagic)

; STEP 4-7: Aggiornate le 4 funzioni UpdateGridXStatus() con safety check

File_Modificato_4 = Trading/GridBSystem.mqh
Funzione_Modificata_4a = UpdateGridBUpperStatus() (riga 221-239)
Funzione_Modificata_4b = UpdateGridBLowerStatus() (riga 277-295)

File_Modificato_5 = Trading/GridASystem.mqh
Funzione_Modificata_5a = UpdateGridAUpperStatus() (riga 238-258)
Funzione_Modificata_5b = UpdateGridALowerStatus() (riga 298-316)

; ============================================================================
[LOGICA_DELLA_SOLUZIONE]
; ============================================================================

; PRIMA (bug):
; OnTradeTransaction -> ignora DEAL_ENTRY_IN -> OnTick -> race condition -> CANCELLED -> DUPLICATO

; DOPO (fix):
; OnTradeTransaction -> gestisce DEAL_ENTRY_IN -> ProcessOrderFilled() -> STATUS = FILLED
; OnTick -> status gia FILLED -> salta blocco PENDING -> nessun CANCELLED -> NESSUN DUPLICATO

; La chiave e che OnTradeTransaction viene eseguito PRIMA di OnTick.
; Aggiornando lo status in OnTradeTransaction, il polling in OnTick trova
; lo status gia corretto e non entra nel blocco che potrebbe settare CANCELLED.

; ============================================================================
[SAFETY_NET]
; ============================================================================

; Come protezione extra, le funzioni UpdateGridXStatus() ora:
; 1. Controllano se lo status e gia FILLED (aggiornato da OnTradeTransaction)
; 2. Usano FindPositionAtPrice() come fallback prima di marcare CANCELLED

; Questo copre edge case come:
; - Lag di rete estremo
; - Comportamento edge case di MT5
; - Bug futuri nel broker

; ============================================================================
[FILE_MODIFICATI_RIEPILOGO]
; ============================================================================

[Modifiche]
Trading_PositionMonitor_mqh = Aggiunto handling DEAL_ENTRY_IN e ProcessOrderFilled()
Utils_Helpers_mqh = Aggiunta FindPositionAtPrice()
Trading_GridBSystem_mqh = Aggiornate UpdateGridBUpperStatus() e UpdateGridBLowerStatus()
Trading_GridASystem_mqh = Aggiornate UpdateGridAUpperStatus() e UpdateGridALowerStatus()

; ============================================================================
[VERIFICA_POST_FIX]
; ============================================================================

; Per verificare che il fix funzioni:
; 1. Compilare EA senza errori/warning
; 2. Eseguire su EURUSD o GBPUSD
; 3. Attendere che un ordine pending venga filled
; 4. Verificare nei log che appaia:
;    "Order FILLED (via OnTradeTransaction)" invece di "Order cancelled"
; 5. Verificare che NON vengano piazzati ordini duplicati

; ============================================================================
[CONCLUSIONE]
; ============================================================================

; Il bug era causato da una RACE CONDITION tra:
; - L'esecuzione del deal da parte di MT5
; - Il polling dello status in OnTick
;
; L'handler esistente (ProcessDealEvent) ignorava i DEAL_ENTRY_IN,
; quindi l'aggiornamento dello status dipendeva solo dal polling,
; che soffriva della race condition.
;
; La soluzione implementata gestisce DEAL_ENTRY_IN nell'handler,
; aggiornando lo status PRIMA del polling, eliminando la race condition.
;
; Versione: v9.23
; Fix applicato il: 15 Gennaio 2026

; ============================================================================
[COMPATIBILITA_RECOVERY_AUTOSAVE]
; ============================================================================
; Analisi effettuata su RecoveryManager.mqh e StatePersistence.mqh per
; verificare che i fix non interferiscano con il sistema di recovery/autosave.

Interferenza_Recovery = NESSUNA
Interferenza_Autosave = NESSUNA
Nuove_Variabili_Da_Salvare = NESSUNA

; ANALISI RECOVERY (RecoveryManager.mqh):
; - ResetArraysForRecovery() resetta tutti gli status a ORDER_NONE
; - RecoverPendingOrders() imposta status = ORDER_PENDING per ordini trovati
; - RecoverOpenPositions() imposta status = ORDER_FILLED per posizioni trovate
; - Il fix usa le stesse variabili gridX_Status[] gia gestite dal recovery

; ANALISI AUTOSAVE (StatePersistence.mqh):
; - Autosave salva gridX_Status[i] (riga 299-307)
; - Merge logic ripristina solo ORDER_CLOSED_TP/SL/CANCELLED (riga 719-726)
; - ORDER_FILLED non viene ripristinato dal merge (CORRETTO perche se position
;   esiste il recovery la trova, se non esiste era chiusa e cycling continua)

; PERCHE IL FIX E COMPATIBILE:
; 1. ProcessOrderFilled() aggiorna solo gridX_Status[] - variabile gia salvata
; 2. Non introduce nuove variabili da persistere
; 3. Aggiorna lo status PIU VELOCEMENTE (via OnTradeTransaction)
; 4. Recovery scansiona sempre il broker - non dipende da dati salvati per FILLED

; SCENARIO TESTATO:
; EA attivo -> ordine filled -> ProcessOrderFilled() -> status=ORDER_FILLED
; Autosave (5 min) -> salva ORDER_FILLED
; EA restart -> Recovery trova position -> status=ORDER_FILLED (OK)
; OPPURE: position chiusa durante downtime -> status=ORDER_NONE -> cycling continua (OK)

Verifica_Completata = SI
Data_Verifica = 15 Gennaio 2026

